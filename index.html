<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>íŠ¸ëŸ¬í”Œë§ˆì¼“</title>
<style>
  body {
    font-family: sans-serif;
    margin: 20px;
    background: #f9f9f9;
  }
  .container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  input, button, textarea {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    box-sizing: border-box;
  }
  .item {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
    position: relative;
  }
  .item img {
    max-width: 100px;
    max-height: 80px;
    vertical-align: middle;
    margin-right: 10px;
  }
  .item-actions {
    margin-top: 6px;
  }
  .chat-container {
    max-width: 600px;
    margin: 20px auto;
    background: white;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  .chat-messages {
    height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 8px;
    margin-bottom: 10px;
  }
  .chat-message {
    margin-bottom: 6px;
  }
  .chat-message b {
    margin-right: 4px;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body>

<div class="container" id="loginPage">
  <h2>íŠ¸ëŸ¬í”Œë§ˆì¼“ ë¡œê·¸ì¸</h2>
  <input type="text" id="studentId" placeholder="í•™ë²ˆ (ì˜ˆ: 5101)" />
  <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
  <button onclick="login()">ë¡œê·¸ì¸</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div class="container" id="mainPage" style="display:none;">
  <h2>íŠ¸ëŸ¬í”Œë§ˆì¼“ ğŸ›’</h2>
  <p><b id="userInfo"></b>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</p>

  <h3>ìƒˆ ë¬¼ê±´ ë“±ë¡</h3>
  <input type="text" id="itemName" placeholder="ë¬¼ê±´ ì´ë¦„" />
  <input type="number" id="price" placeholder="ê°€ê²© (ì„œì°½)" />
  <input type="file" id="itemImage" accept="image/*" />
  <button onclick="addItem()">ë“±ë¡</button>

  <h3>íŒë§¤ ëª©ë¡</h3>
  <div id="itemList"></div>
</div>

<div class="chat-container" id="chatPage" style="display:none;">
  <h3>ì±„íŒ…</h3>
  <div class="chat-messages" id="chatMessages"></div>
  <textarea id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="2"></textarea>
  <button onclick="sendChat()">ì „ì†¡</button>
</div>

<script>
  // Firebase ì„¤ì •
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
  };
  firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const storage = firebase.storage();

  // ë¡œê·¸ì¸ ê°€ëŠ¥í•œ í•™ë²ˆ ëª©ë¡ (20ë²ˆ ì—†ìŒ)
  const validIds = Array.from({length:23}, (_,i)=>i+1)
    .filter(n=>n!==20)
    .map(n=>"51"+String(n).padStart(2,'0'));

  let currentUser = null;
  let editingId = null; // ìˆ˜ì •ì¤‘ì¸ ì•„ì´í…œ ID

  // ë¡œê·¸ì¸ í•¨ìˆ˜
  function login(){
    const id = document.getElementById('studentId').value.trim();
    const pw = document.getElementById('password').value.trim();

    if(pw !== "1234"){
      document.getElementById('loginMsg').innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
      return;
    }
    if(!validIds.includes(id)){
      document.getElementById('loginMsg').innerText = "ìœ íš¨í•˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤.";
      return;
    }

    currentUser = id;
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainPage').style.display = 'block';
    document.getElementById('chatPage').style.display = 'block';
    document.getElementById('userInfo').innerText = currentUser;

    loadItems();
    loadChats();
  }

  // ë¬¼ê±´ ë“±ë¡ í•¨ìˆ˜
  async function addItem(){
    const name = document.getElementById('itemName').value.trim();
    const price = document.getElementById('price').value.trim();
    const imageFile = document.getElementById('itemImage').files[0];

    if(!name || !price || price <= 0){
      alert('ë¬¼ê±´ ì´ë¦„ê³¼ ì˜¬ë°”ë¥¸ ê°€ê²©(ì„œì°½)ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    let imageUrl = "";
    if(imageFile){
      const imgRef = storage.ref().child(`itemImages/${currentUser}_${Date.now()}_${imageFile.name}`);
      await imgRef.put(imageFile);
      imageUrl = await imgRef.getDownloadURL();
    }

    await db.collection("items").add({
      itemName: name,
      price: Number(price),
      seller: currentUser,
      status: "íŒë§¤ì¤‘",
      imageUrl: imageUrl,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ì´ˆê¸°í™”
    document.getElementById('itemName').value = '';
    document.getElementById('price').value = '';
    document.getElementById('itemImage').value = '';

    loadItems();
  }

  // ì•„ì´í…œ ë¶ˆëŸ¬ì˜¤ê¸° & ë Œë”ë§
  async function loadItems(){
    const snapshot = await db.collection("items").orderBy("created", "desc").get();
    const list = document.getElementById('itemList');
    list.innerHTML = "";

    snapshot.forEach(doc=>{
      const item = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'item';

      let imgTag = "";
      if(item.imageUrl){
        imgTag = `<img src="${item.imageUrl}" alt="ì‚¬ì§„" />`;
      }

      // ìˆ˜ì • ì¤‘ì¸ ì•„ì´í…œ ë Œë”ë§
      if(editingId === id && item.seller === currentUser){
        div.innerHTML = `
          <input type="text" id="editName" value="${item.itemName}" />
          <input type="number" id="editPrice" value="${item.price}" />
          <select id="editStatus">
            <option value="íŒë§¤ì¤‘" ${item.status==="íŒë§¤ì¤‘"?"selected":""}>íŒë§¤ì¤‘</option>
            <option value="íŒë§¤ì™„ë£Œ" ${item.status==="íŒë§¤ì™„ë£Œ"?"selected":""}>íŒë§¤ì™„ë£Œ</option>
          </select>
          <button onclick="saveEdit('${id}')">ì €ì¥</button>
          <button onclick="cancelEdit()">ì·¨ì†Œ</button>
        `;
      } else {
        div.innerHTML = `
          ${imgTag} <b>${item.itemName}</b> â€“ ${item.price} ì„œì°½<br/>
          íŒë§¤ì: ${item.seller} | ìƒíƒœ: ${item.status}
        `;

        // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
        if(item.seller === currentUser){
          const btnEdit = document.createElement('button');
          btnEdit.innerText = 'ìˆ˜ì •';
          btnEdit.onclick = () => {
            editingId = id;
            loadItems();
          };
          const btnDelete = document.createElement('button');
          btnDelete.innerText = 'ì‚­ì œ';
          btnDelete.onclick = () => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
              db.collection("items").doc(id).delete().then(loadItems);
            }
          };
          const btnComplete = document.createElement('button');
          btnComplete.innerText = item.status === "íŒë§¤ì¤‘" ? "íŒë§¤ì™„ë£Œë¡œ ë³€ê²½" : "íŒë§¤ì¤‘ìœ¼ë¡œ ë³€ê²½";
          btnComplete.onclick = () => {
            db.collection("items").doc(id).update({
              status: item.status === "íŒë§¤ì¤‘" ? "íŒë§¤ì™„ë£Œ" : "íŒë§¤ì¤‘"
            }).then(loadItems);
          };

          const actionDiv = document.createElement('div');
          actionDiv.className = 'item-actions';
          actionDiv.appendChild(btnEdit);
          actionDiv.appendChild(btnDelete);
          actionDiv.appendChild(btnComplete);
          div.appendChild(actionDiv);
        }
      }

      list.appendChild(div);
    });
  }

  // ìˆ˜ì • ì €ì¥ í•¨ìˆ˜
  async function saveEdit(id){
    const newName = document.getElementById('editName').value.trim();
    const newPrice = document.getElementById('editPrice').value.trim();
    const newStatus = document.getElementById('editStatus').value;

    if(!newName || !newPrice || newPrice <= 0){
      alert('ë¬¼ê±´ ì´ë¦„ê³¼ ì˜¬ë°”ë¥¸ ê°€ê²©(ì„œì°½)ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    await db.collection("items").doc(id).update({
      itemName: newName,
      price: Number(newPrice),
      status: newStatus
    });
    editingId = null;
    loadItems();
  }

  function cancelEdit(){
    editingId = null;
    loadItems();
  }

  // ì±„íŒ… ê¸°ëŠ¥

  const chatMessagesDiv = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');

  function loadChats(){
    db.collection("chat").orderBy("created", "asc").onSnapshot(snapshot=>{
      chatMessagesDiv.innerHTML = "";
      snapshot.forEach(doc=>{
        const msg = doc.data();
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.innerHTML = `<b>${msg.user}</b>: ${escapeHtml(msg.text)}`;
        chatMessagesDiv.appendChild(div);
      });
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    });
  }

  function sendChat(){
    const text = chatInput.value.trim();
    if(!text) return;

    db.collection("chat").add({
      user: currentUser,
      text: text,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatInput.value = "";
  }

  // XSS ë°©ì§€ìš© escape í•¨ìˆ˜
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    })[m]);
  }

</script>
</body>
</html>
